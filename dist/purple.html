<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css"/>		
		<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
        <script src="../js/sha256.js"></script>
		<style>
.table-fixed {
	width: 100%;
	border: 1px silver solid;
}
table.table-fixed tbody {
	height:120px;
	overflow-y:auto;
	width: 100%;
}
table.table-fixed thead,tbody,tr,td,th{
    display:block;
}
table.table-fixed tbody td {
    float:left;
}
table.table-fixed thead tr th {
	float:left;
}
.call-log-card {
	text-align: center;
}
.call-log-row {
	padding-bottom:15px;
}
.voicemail-button {
	width:32px;
	margin-right:2px;
}
		</style>
	</head>
	<body style="padding-top:105px">
		<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
		<a class="navbar-brand" href="#">
			<img alt="Brand" height="60" src="https://www.spectrio.com/wp-content/uploads/2015/03/Spectrio_Logo2015_273x96.png"/>		
			Guest Wifi POC		
		</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item"><a class="nav-link" href="#venues-section">Venues</a></li>
			</ul>
			<ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                </ul>		
            </div>
		</nav>		

		<div class="container-fluid">
            <form>
            <div class="form-group row" id="venues-section">
                <label for="venues" class="col-sm-2">Venues</label>
                <div class="col-sm-8">
                    <select class="form-control" id="venues-select" name="venues">
                        <option value="-1">Select Venue</option>
                    </select>
                    
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-primary venues-enabled" id="export-all" type="button" disabled="true">Export All</button>
                </div>
            </div>
            <div class="form-group row" id="venues-section">
                <label for="phoneNumbers" class="col-sm-2">Details</label>
                <div class="col-sm-5">
                    <textarea class="form-control" name="address" readonly="true" style="height:160px;"></textarea>
                </div>
                <div class="col-sm-5">
                    <div id="map" style="width:100%;height:160px;"></div>
                </div>
            </div>
            </form>            
            <div class="row pb-2" id="metrics-section">
                <div class="col-sm-10 offset-sm-2">
                    <div class="card-deck">
                        <div class="card call-log-card bg-primary">
                            <div class="card-body">
                                <h1 class="card-title text-white" id="onlineNow">--</h1>
                            </div>
                            <div class="card-footer bg-light text-primary">
                                Guests Online <nobr>Now&nbsp;&nbsp;</nobr>
                            </div>
                        </div>
                        <div class="card call-log-card bg-primary">
                            <div class="card-body">
                                <h1 class="card-title text-white" id="online24">--</h1>
                            </div>
                            <div class="card-footer bg-light text-primary">
                                Guests Online <nobr>Last 24 Hours&nbsp;&nbsp;</nobr>
                            </div>
                        </div>
                    </div>
                </div>		
            </div>
            <div class="row pt-2" id="exports-section">
                <div class="col-sm-10 offset-sm-2">
                    <div class="btn-group">
                        <button type="button" id="export-visitors" data-days="30" class="export-btn btn btn-primary" disabled="true">Export Guests Last <span id="visitor-days">30</span> Days</button>
                        <button type="button" class="export-btn btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled="true">
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item visitors-range" href="#" data-days="7">7 Days</a>
                            <a class="dropdown-item visitors-range" href="#" data-days="30">30 Days</a>
                            <a class="dropdown-item visitors-range" href="#" data-days="90">90 Days</a>
                            <a class="dropdown-item visitors-range" href="#" data-days="180">180 Days</a>
                            <a class="dropdown-item visitors-range" href="#" data-days="365">365 Days</a>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="modal fade" data-backdrop="static" id="loginModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Login</h5>
                        </div>
                        <div class="modal-body">
                            <div id="login-error" class="alert alert-danger" role="alert" style="display:none"></div>
                            <form>
                                <div class="form-group row">
                                    <label for="name" class="col-sm-2">Username</label>
                                    <div class="col-sm-10">
                                    <input class="form-control" name="username"/>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="name" class="col-sm-2">Password</label>
                                    <div class="col-sm-10">
                                    <input class="form-control" type="password" name="password"/>
                                    </div>
                                </div>
                            </form>						
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="login-button" class="btn btn-primary">Login</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ADMIN -->
            <div class="row"><hr class="col-sm-12"/></div>
            <div class="form-group row" id="store-section">
                <label for="name" class="col-sm-2">Admin</label>
                <div class="col-sm-10">
                    <div class="btn-group">
                        <button type="button" id="store-all" data-days="30" class="btn btn-warning venues-enabled" disabled="true">Store All Guests Last <span id="visitor-days2">30</span> Days</button>
                        <button type="button" class="btn btn-warning dropdown-toggle dropdown-toggle-split venues-enabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled="true">
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item store-range" href="#" data-days="7">7 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="30">30 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="90">90 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="180">180 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="365">365 Days</a>
                        </div>
                    </div>
                    <button class="btn btn-warning" type="button" id="store-venues">Store All Venues</button>                                         
                    <button class="btn btn-warning" type="button" id="store-customers">Store Customers</button>                                         
                </div>
            </div>
            <!-- END ADMIN -->
        
		<script>
            var proxyHost = 'pyhc0dlbjk.execute-api.us-east-1.amazonaws.com';
            var purpleProxy = 'https:/'+proxyHost+'/dev/purpleProxy';
            var venues;
			function getVenues() {
                var path = '/api/company/v1/venues';
                console.log(purpleProxy + '?path='+path);
				$.ajax(purpleProxy + '?path='+path)
				    .done(function(responseObj) {
                        console.log(responseObj);
                        if (responseObj.success && responseObj.data.venues) {
                            venues = responseObj.data.venues;
                            venues.sort(function(a, b){return a.name.localeCompare(b.name);});
                            $.each(venues, function(idx, itm) {
                                $('#venues-select').append('<option value="'+itm.id+'">'+itm.name+'</name>');
                            });
                            $('.venues-enabled').removeAttr('disabled');
                        }
				    });
            }
			function exportVisitors() {
                var path = '/api/company/v1/venue/'+$('#venues-select').val()+'/visitors?';
                var days = parseInt($('#export-visitors').data('days'));
                path += ('from='+moment().add(-1*days, 'days').format('YYYYMMDD'));
                path += ('&to='+moment().format('YYYYMMDD'));
                console.log(purpleProxy + '?path='+path);
				$.ajax(purpleProxy + '?path='+path)
				    .done(function(responseObj) {
                        console.log(responseObj);
                        if (responseObj.success && responseObj.data.visitors) {
                            var visitors = responseObj.data.visitors;
                            var csv = 'id,first_name,last_name,gender,date_of_birth,location,email,mobile,first_seen,last_seen,visits,source\r\n';
                            $.each(visitors, function(idx, itm) {
                                csv +=(itm.id+',"'+itm.first_name+'","'+(itm.last_name||'')+'","'+(itm.gender||'')+'","'+(itm.date_of_birth||'')+'","'+(itm.location||'')+'","'+(itm.email||'')+'","'+(itm.mobile||'')+'","'+(itm.first_seen||'')+'",'+itm.last_seen+','+itm.visits+',"'+itm.source+'"');
                                csv += '\r\n';
                            });
                            exportCSV(csv, 'guests.csv');
                        }
                        else {
                            alert('No guests found.');
                        }
				    });
            }

            var map;
            function myMap() {
                var mapCanvas = document.getElementById("map");
                var mapOptions = {
                    //center: new google.maps.LatLng(51.5, -0.2),
                    zoom: 14
                };
                map = new google.maps.Map(mapCanvas, mapOptions);
                if (Cookies.get('loggedInX')!='true') {
                    $('#loginModal').modal('show');
                }
                else {
                    getVenues();
                }
            }

            function exportCSV(csv, name) {
                let csvContent = "data:text/csv;charset=utf-8,"+csv;
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", name);
                document.body.appendChild(link); // Required for FF
                link.click(); // This will download the data file named "my_data.csv". 
                document.body.removeChild(link);               
            }

            function selectVenue(matchId) {
                var venue = $.grep(venues, function(itm, idx) {
                    return itm.id == matchId;
                });
                var addressString = '';
                if (venue.length) {
                    addressString = venue[0].name + '\n'+venue[0].address1+'\n';
                    if (venue[0].address2) addressString += venue[0].address2 + '\n';
                    if (venue[0].address3) addressString += venue[0].address3 + '\n';
                    if (venue[0].address4) addressString += venue[0].address4 + '\n';
                    if (venue[0].town) addressString += venue[0].town + '\n';
                    $('#onlineNow').text(venue[0].users_online_now);
                    $('#online24').text(venue[0].users_online_24_hours);
                    if (venue[0].hardware && venue[0].hardware.length) {
                        console.log(venue[0].hardware);
                        addressString += ('Hardware: '+venue[0].hardware[0].name + ' ('+venue[0].hardware[0].brand+')\n');
                    }
                    addressString += ('Status: '+venue[0].status + '\n');
                    var myCenter = new google.maps.LatLng(venue[0].latitude,venue[0].longitude);
                    var marker = new google.maps.Marker({position: myCenter, venueId:venue[0].id});
                    marker.setMap(map);
                    map.setCenter(myCenter);
                    
                }
                $('[name="address"]').val(addressString);        
                $('.export-btn').removeAttr('disabled');       
            }

            $(document).ready(function() {
                $('#venues-select').on('change', function(evt) {
                    var sel = $(this);
                    var matchId = parseInt(sel.val());
                    selectVenue(matchId);
                });
                $('#export-visitors').on('click', function() {
                    exportVisitors();
                });
                $('.visitors-range').on('click', function() {
                    var days = $(this).data('days');
                    $('#export-visitors').data('days', days);
                    $('#visitor-days').text(days);
                });
                $('.store-range').on('click', function() {
                    var days = $(this).data('days');
                    $('#store-all').data('days', days);
                    $('#visitor-days2').text(days);
                });
                $('#export-all').on('click', function() {
                    var csv = 'id,name,address1,address2,address3,address4,town,telephone,email,users_online_now,users_online_24_hours,status\r\n';
                    $.each(venues, function(idx, itm) {
                        csv +=(itm.id+',"'+itm.name+'","'+(itm.address1||'')+'","'+(itm.address2||'')+'","'+(itm.address3||'')+'","'+(itm.address4||'')+'","'+(itm.town||'')+'","'+(itm.telephone||'')+'","'+(itm.email||'')+'",'+itm.users_online_now+','+itm.users_online_24_hours+',"'+itm.status+'"');
                        csv += '\r\n';
                    });
                    exportCSV(csv, 'venues.csv');
                });

				$('#login-button').on('click', function() {
					var b = eval(atob('YnRvYSgkKCdbbmFtZT0icGFzc3dvcmQiXScpLnZhbCgpKSA9PSAnTVRJelUzQmxZM1J5YVc4a0pBPT0nICYmIGJ0b2EoJCgnW25hbWU9InVzZXJuYW1lIl0nKS52YWwoKSkgPT0gJ1UzQmxZM1J5YVc4PSc='));
					if (b)  {
						$('#login-error').hide();
						getVenues();
						$('#loginModal').modal('hide');
                        Cookies.set('loggedInX', 'true', {expires:1/24});
					}
					else {
						$('#login-error').text('Invalid username or password');
						$('#login-error').show();
                        Cookies.set('loggedInX', 'false', {expires:1/24});
					}
				});
            });
        </script>
        <script>
            // ADMIN            
            var purpleStore = 'https:/'+proxyHost+'/dev/purpleStore';
            var customerURL = 'https:/'+proxyHost+'/dev/customer';
			function storeCustomers() {
                var customers = [
                    {
                        id: 4286,
                        publicKey: 'ca722481fcff8361d4fe2ac3a476aba4',
                        privateKey: 'fcc4780fc12bdf89e0bc81371e45d9b3'
                    }
                ];
                $.each(customers, function(idx, customer){
                    $.ajax({
                        contentType: "application/json; charset=utf-8",
			            dataType: "json",
                        url:customerURL + '/'+customer.id,
                        type:'POST',
                        data: JSON.stringify(customer)
                    })
				    .done(function(responseObj) {
                        console.log(responseObj);
				    });
                });
                alert('Done');
            }
            function storeAllVisitors() {
                var range = parseInt($('#store-all').data('days'));
                var s = moment().add(-1*range, 'days').format('YYYYMMDD');
                console.log(s);
                var e = moment().format('YYYYMMDD');
                $.each(venues, function(idx, venue) {
                    var p = '/api/company/v1/venue/'+venue.id+'/visitors?from='+s+'&to='+e;
                    console.log(p);
                    $.ajax(purpleStore + '?customerId=4286&dataField=visitors&path='+p)
				    .done(function(responseObj) {
                        console.log(responseObj);
                    });
                });
                alert('Done!');
            }
            function storeVenues() {
                var p = '/api/company/v1/venues';
                $.ajax(purpleStore + '?customerId=4286&dataField=venues&path='+p)
                .done(function(responseObj) {
                    console.log(responseObj);
                });
                alert('Done!');
            }

            $(document).ready(function() {
                // ADMIN
                $('#store-all').on('click', function() {
                    storeAllVisitors();
                });
                $('#store-venues').on('click', function() {
                    storeVenues();
                });
                $('#store-customers').on('click', function() {
                    storeCustomers();
                });
                // END ADMIN

            });            
            // END ADMIN               
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDs1ehZE1qyN6A-PvP1RuLxoXuQ35b2goA&callback=myMap"></script>        
    </body>

</html>
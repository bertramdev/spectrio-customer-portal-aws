<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css"/>		
		<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        
		<style>
.table-fixed {
	width: 100%;
	border: 1px silver solid;
}
table.table-fixed tbody {
	height:120px;
	overflow-y:auto;
	width: 100%;
}
table.table-fixed thead,tbody,tr,td,th{
    display:block;
}
table.table-fixed tbody td {
    float:left;
}
table.table-fixed thead tr th {
	float:left;
}
.call-log-card {
	text-align: center;
}
.call-log-row {
	padding-bottom:15px;
}
.voicemail-button {
	width:32px;
	margin-right:2px;
}
		</style>
	</head>
	<body style="padding-top:105px">
		<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
		<a class="navbar-brand" href="#">
			<img alt="Brand" height="60" src="https://www.spectrio.com/wp-content/uploads/2015/03/Spectrio_Logo2015_273x96.png"/>		
			Wifi POC		
		</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item"><a class="nav-link" href="#venues-section">Venues</a></li>
			</ul>
			<ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link small" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a id="logout" class="nav-link small" href="#">Logout</a>
                </li>

            </ul>		
        </div>
		</nav>		

		<div class="container-fluid">
            <form>
            <div class="form-group row" id="venues-section">
                <label for="venues" class="col-sm-2">Venues</label>
                <div class="col-sm-8">
                    <select class="form-control" id="venues-select" name="venues">
                        <option value="-1">Select Venue</option>
                    </select>
                    
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-primary venues-enabled" id="export-all" type="button" disabled="true">Export All</button>
                </div>
            </div>

            <div id="venue-detail" style="display:none">

            <div class="form-group row" id="venues-section">
                <label for="phoneNumbers" class="col-sm-2">Details</label>
                <div class="col-sm-5">
                    <textarea class="form-control" name="address" readonly="true" style="height:160px;"></textarea>
                </div>
                <div class="col-sm-5">
                    <div id="map" style="width:100%;height:160px;"></div>
                </div>
            </div>
            </form>            
            <div class="row pb-2" id="metrics-section">
                <div class="col-sm-10 offset-sm-2">
                    <div class="card-deck">
                        <div class="card call-log-card bg-primary">
                            <div class="card-body">
                                <h1 class="card-title text-white" id="onlineNow">--</h1>
                            </div>
                            <div class="card-footer bg-light text-primary">
                                Guests Online <nobr>Now&nbsp;&nbsp;</nobr>
                            </div>
                        </div>
                        <div class="card call-log-card bg-primary">
                            <div class="card-body">
                                <h1 class="card-title text-white" id="online24">--</h1>
                            </div>
                            <div class="card-footer bg-light text-primary">
                                Guests Online <nobr>Last 24 Hours&nbsp;&nbsp;</nobr>
                            </div>
                        </div>
                    </div>
                </div>		
            </div>
            <div class="row pb-2 pt-2" id="agg-section">
                <label for="" class="col-sm-2">Analytics</label>
                <div class="col-sm-10">
                    <div style="text-align:center" class="pb-1">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons" id="agg-days">
                        <label class="btn btn-secondary btn-sm">
                            <input class="export-btn" disabled="true" type="radio" name="agg-days" id="days1" autocomplete="off" value="1"> 1d
                        </label>
                        <label class="btn btn-secondary btn-sm">
                            <input class="export-btn" disabled="true" type="radio" name="agg-days" id="days7" autocomplete="off" value="7"> 7d
                        </label>
                        <label class="btn btn-secondary btn-sm active">
                            <input class="export-btn" disabled="true" type="radio" name="agg-days" id="days30" autocomplete="off" checked="true" value="30"> 30d
                        </label>
                        <label class="btn btn-secondary btn-sm">
                            <input class="export-btn" disabled="true" type="radio" name="agg-days" id="days90" autocomplete="off" value="90"> 90d
                        </label>
                        <label class="btn btn-secondary btn-sm">
                            <input class="export-btn" disabled="true" type="radio" name="agg-days" id="days180" autocomplete="off" value="180"> 180d
                        </label>
                        <label class="btn btn-secondary btn-sm">
                            <input class="export-btn" disabled="true" type="radio" name="agg-days" id="days365" autocomplete="off" value="365"> 365d
                        </label>
    
                    </div>
                    </div>
                    <div class="card-deck">
                        <div class="card call-log-card">
                            <div class="card-header bg-light">
                                 Total Guests
                            </div>
                            <div class="card-body text-center" style="padding-top:60px">
                                <span id="visitors" style="font-size:160px; font-weight:800;line-height:.95;">--</span>
                                <br/>
                                <span style="font-size:16px; font-weight:400;"><span id="visits">--</span> total visits</span>                                
                                <br/>
                                <button type="button" id="export-visitors" class="export-btn btn btn-primary btn-sm mt-4" disabled="true">Export Guests</button>
                            </div>
                        </div>
                        <div class="card call-log-card">
                            <div class="card-header bg-light">
                                <span id="sources">--</span> Login Sources Captured
                            </div>
                            <div class="card-body">
                                <div id="source-pie" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>		
            </div>
            <div class="row pb-2" id="agg-section">
                <div class="col-sm-10 offset-sm-2">
                    <div class="card-deck">
                        <div class="card call-log-card">
                            <div class="card-header bg-light">
                                <span id="gender">--</span> Genders Captured
                            </div>
                            <div class="card-body">
                                <div id="gender-pie" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                        <div class="card call-log-card">
                            <div class="card-header bg-light">
                                <span id="age">--</span> Ages Captured
                            </div>
                            <div class="card-body">
                                <div id="age-pie" style="width: 100%; height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>		
            </div>
            </div>            
            <div class="modal fade" data-backdrop="static" id="loginModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Login</h5>
                        </div>
                        <div class="modal-body">
                            <div id="login-error" class="alert alert-danger" role="alert" style="display:none"></div>
                            <form>
                                <div class="form-group row">
                                    <label for="name" class="col-sm-2">Username</label>
                                    <div class="col-sm-10">
                                    <input class="form-control" name="username"/>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="name" class="col-sm-2">Password</label>
                                    <div class="col-sm-10">
                                    <input class="form-control" type="password" name="password"/>
                                    </div>
                                </div>
                            </form>						
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="login-button" class="btn btn-primary">Login</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ADMIN -->
            <div class="row"><hr class="col-sm-12"/></div>
            <div class="form-group row" id="store-section">
                <label for="name" class="col-sm-2">Admin</label>
                <div class="col-sm-10">
                    <div class="btn-group">
                        <button type="button" id="store-all" data-days="30" class="btn btn-warning venues-enabled" disabled="true">Store All Guests Last <span id="visitor-days2">30</span> Days</button>
                        <button type="button" class="btn btn-warning dropdown-toggle dropdown-toggle-split venues-enabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled="true">
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item store-range" href="#" data-days="7">7 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="30">30 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="90">90 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="180">180 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="365">365 Days</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END ADMIN -->
        </div>
        
		<script>
            var proxyHost = 'mnk2ecc85j.execute-api.us-east-1.amazonaws.com';
            var customerURL = 'https:/'+proxyHost+'/dev/customer';
            var purpleProxy = 'https:/'+proxyHost+'/dev/purpleProxy';
            var purpleFetchAggs = 'https:/'+proxyHost+'/dev/purpleFetchVenueDailyTotals';
            var accountId = 4286;
            var customerId;
            var venues;
			function getVenues() {
                var path = '/api/company/v1/venues';
                console.log(purpleProxy + '?customerId='+ customerId+ '&path='+path);
				$.ajax(purpleProxy + '?customerId='+ customerId+ '&path='+path)
				    .done(function(responseObj) {
                        console.log(responseObj);
                        if (responseObj.success && responseObj.data.venues) {
                            venues = responseObj.data.venues;
                            venues.sort(function(a, b){return a.name.localeCompare(b.name);});
                            $.each(venues, function(idx, itm) {
                                $('#venues-select').append('<option value="'+itm.id+'">'+itm.name+'</name>');
                            });
                            $('.venues-enabled').removeAttr('disabled');
                        }
				    });
            }
			function exportVisitors() {
                var path = '/api/company/v1/venue/'+$('#venues-select').val()+'/visitors?';
                let days = parseInt($('[name="agg-days"]:checked').val());

                path += ('from='+moment().add(-1*days, 'days').format('YYYYMMDD'));
                path += ('&to='+moment().format('YYYYMMDD'));
                console.log(purpleProxy + '?path='+path);
				$.ajax(purpleProxy + '?customerId='+ customerId+ '&path='+encodeURIComponent(path))
				    .done(function(responseObj) {
                        console.log(responseObj);
                        if (responseObj.success && responseObj.data.visitors) {
                            var visitors = responseObj.data.visitors;
                            var csv = 'id,first_name,last_name,gender,date_of_birth,location,email,mobile,first_seen,last_seen,visits,source\r\n';
                            $.each(visitors, function(idx, itm) {
                                csv +=(itm.id+',"'+itm.first_name+'","'+(itm.last_name||'')+'","'+(itm.gender||'')+'","'+(itm.date_of_birth||'')+'","'+(itm.location||'')+'","'+(itm.email||'')+'","'+(itm.mobile||'')+'","'+(itm.first_seen||'')+'",'+itm.last_seen+','+itm.visits+',"'+itm.source+'"');
                                csv += '\r\n';
                            });
                            exportCSV(csv, 'guests.csv');
                        }
                        else {
                            alert('No guests found.');
                        }
				    });
            }

            var map;
            function myMap() {
                var mapCanvas = document.getElementById("map");
                var mapOptions = {
                    //center: new google.maps.LatLng(51.5, -0.2),
                    zoom: 14
                };
                map = new google.maps.Map(mapCanvas, mapOptions);
                if (Cookies.get('loggedInX')!='true') {
                    $('#loginModal').modal('show');
                }
                else {
                    init();
                }
            }

            function init() {
				$.ajax(customerURL+'/'+accountId)
				.done(function(respObj) {
					if (respObj && respObj.success) {
                        customerId = respObj.data.purpleAccountId;
                        getVenues();                        
					}
					else {
						alert('Huge problem!');
					}
				});                
            }

            function exportCSV(csv, name) {
                let csvContent = "data:text/csv;charset=utf-8,"+csv;
                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", name);
                document.body.appendChild(link); // Required for FF
                link.click(); // This will download the data file named "my_data.csv". 
                document.body.removeChild(link);               
            }

            function loadAnalytics(matchId) {
                let days = parseInt($('[name="agg-days"]:checked').val()),
                    to  = moment(),
                    from = moment().add(-1*days, 'days');
                let fromP = from.format('YYYYMMDD'),
                    toP = to.format('YYYYMMDD');
                let aggUrl = purpleFetchAggs + '?customerId='+customerId+'&venueId='+matchId+'&from='+fromP+'&to='+toP;
                $.ajax(aggUrl)
                .done(function(responseObj) {
                    console.log(responseObj);
                    if (responseObj.success && responseObj.data) {
                        $('#sources').text(responseObj.data.sourceCaptured);
                        $('#age').text(responseObj.data.ageCaptured);
                        $('#visitors').text(responseObj.data.visitors);
                        $('#visits').text(Math.max(responseObj.data.visits,responseObj.data.visitors));
                        $('#gender').text(responseObj.data.genderCaptured);

                        var data = [['Gender', 'Count']];
                        for (let k in responseObj.data.gender) {
                            data.push([k.substr(0,1).toUpperCase()+k.substr(1), responseObj.data.gender[k]]);
                        }
                        console.log(data);
                        let chart = new google.visualization.PieChart(document.getElementById('gender-pie'));
                        chart.draw(google.visualization.arrayToDataTable(data));

                        let ageData = [['Age', 'Count']];
                        for (let k in responseObj.data.age) {
                            ageData.push([k.replace('age','').replace('to', ' to ').replace('Over', 'Over '), responseObj.data.age[k]]);
                        }
                        console.log(ageData);
                        let ageChart = new google.visualization.PieChart(document.getElementById('age-pie'));
                        ageChart.draw(google.visualization.arrayToDataTable(ageData));

                        var sourceData = [['Source', 'Count']];
                        for (let k in responseObj.data.source) {
                            sourceData.push([k.substr(0,1).toUpperCase()+k.substr(1), responseObj.data.source[k]]);
                        }
                        console.log(data);
                        let sourceChart = new google.visualization.PieChart(document.getElementById('source-pie'));
                        sourceChart.draw(google.visualization.arrayToDataTable(sourceData));

                    }
                    else {
                        alert('No guests found.');
                    }
                });
                
            }

            function selectVenue(matchId) {
                var venue = $.grep(venues, function(itm, idx) {
                    return itm.id == matchId;
                });
                var addressString = '';
                if (venue.length) {
                    addressString = venue[0].name + '\n'+venue[0].address1+'\n';
                    if (venue[0].address2) addressString += venue[0].address2 + '\n';
                    if (venue[0].address3) addressString += venue[0].address3 + '\n';
                    if (venue[0].address4) addressString += venue[0].address4 + '\n';
                    if (venue[0].town) addressString += venue[0].town + '\n';
                    $('#onlineNow').text(venue[0].users_online_now);
                    $('#online24').text(venue[0].users_online_24_hours);
                    if (venue[0].hardware && venue[0].hardware.length) {
                        console.log(venue[0].hardware);
                        addressString += ('Hardware: '+venue[0].hardware[0].name + ' ('+venue[0].hardware[0].brand+')\n');
                    }
                    addressString += ('Status: '+venue[0].status + '\n');
                    var myCenter = new google.maps.LatLng(venue[0].latitude,venue[0].longitude);
                    var marker = new google.maps.Marker({position: myCenter, venueId:venue[0].id});
                    marker.setMap(map);
                    map.setCenter(myCenter);
                    // /dev/purpleFetchVenueDailyTotals?customerId=4286&venueId=12427&from=20180101&to=20180328
                    loadAnalytics(matchId);                    
                }
                $('[name="address"]').val(addressString);        
                $('.export-btn').removeAttr('disabled');       
            }

            $(document).ready(function() {
                $('#venues-select').on('change', function(evt) {
                    var sel = $(this);
                    var matchId = parseInt(sel.val());
                    if (matchId > 0) {
                        $('#venue-detail').show();
                        selectVenue(matchId);
                    }
                    else {
                        $('#venue-detail').hide();

                    }

                });
                $('[name="agg-days"]').on('change', function() {
                    let matchId = $('#venues-select').val();
                    loadAnalytics(matchId);

                });
                $('#export-visitors').on('click', function() {
                    exportVisitors();
                });
                $('.store-range').on('click', function() {
                    var days = $(this).data('days');
                    $('#store-all').data('days', days);
                    $('#visitor-days2').text(days);
                });
                $('#export-all').on('click', function() {
                    var csv = 'id,name,address1,address2,address3,address4,town,telephone,email,users_online_now,users_online_24_hours,status\r\n';
                    $.each(venues, function(idx, itm) {
                        csv +=(itm.id+',"'+itm.name+'","'+(itm.address1||'')+'","'+(itm.address2||'')+'","'+(itm.address3||'')+'","'+(itm.address4||'')+'","'+(itm.town||'')+'","'+(itm.telephone||'')+'","'+(itm.email||'')+'",'+itm.users_online_now+','+itm.users_online_24_hours+',"'+itm.status+'"');
                        csv += '\r\n';
                    });
                    exportCSV(csv, 'venues.csv');
                });

				$('#login-button').on('click', function() {
					var b = eval(atob('YnRvYSgkKCdbbmFtZT0icGFzc3dvcmQiXScpLnZhbCgpKSA9PSAnTVRJelUzQmxZM1J5YVc4a0pBPT0nICYmIGJ0b2EoJCgnW25hbWU9InVzZXJuYW1lIl0nKS52YWwoKSkgPT0gJ1UzQmxZM1J5YVc4PSc='));
					if (b)  {
						$('#login-error').hide();
						init();
						$('#loginModal').modal('hide');
                        Cookies.set('loggedInX', 'true', {expires:1/24});
					}
					else {
						$('#login-error').text('Invalid username or password');
						$('#login-error').show();
                        Cookies.set('loggedInX', 'false', {expires:1/24});
					}
				});
				$('#logout').on('click', function(evt) {
					Cookies.set('loggedInX', 'false', {expires:1/(24*60*60)});
					document.location.reload();
				});

            });
        </script>
        <script>
            // ADMIN            
            var purpleStore = 'https:/'+proxyHost+'/dev/purpleStore';
            var customerURL = 'https:/'+proxyHost+'/dev/customer';
            function storeAllVisitors() {
                var range = parseInt($('#store-all').data('days'));
                var s = moment().add(-1*range, 'days').format('YYYYMMDD');
                console.log(s);
                var e = moment().format('YYYYMMDD');
                $.each(venues, function(idx, venue) {
                    var p = '/api/company/v1/venue/'+venue.id+'/visitors?from='+s+'&to='+e;
                    console.log(p);
                    $.ajax(purpleStore + '?customerId=4286&dataField=visitors&path='+p)
				    .done(function(responseObj) {
                        console.log(responseObj);
                    });
                });
                alert('Done!');
            }

            $(document).ready(function() {
                $('#store-all').on('click', function() {
                    storeAllVisitors();
                });

            });            
            // END ADMIN               
        </script>
        <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDs1ehZE1qyN6A-PvP1RuLxoXuQ35b2goA&callback=myMap"></script>        
    </body>

</html>
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css"/>		
		<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>		<style>
.table-fixed {
	width: 100%;
	border: 1px silver solid;
}
table.table-fixed tbody {
	height:120px;
	overflow-y:auto;
	width: 100%;
}
table.table-fixed thead,tbody,tr,td,th{
    display:block;
}
table.table-fixed tbody td {
    float:left;
}
table.table-fixed thead tr th {
	float:left;
}
.call-log-card {
	text-align: center;
}
.call-log-row {
	padding-bottom:15px;
}
.voicemail-button {
	width:32px;
	margin-right:2px;
}
		</style>
	</head>
	<body style="padding-top:105px">
		<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
		<a class="navbar-brand" href="#">
			<img alt="Brand" height="60" src="https://www.spectrio.com/wp-content/uploads/2015/03/Spectrio_Logo2015_273x96.png"/>		
			POC	Admin
		</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link small" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a id="logout" class="nav-link small" href="#">Logout</a>
                </li>
            </ul>		
        </div>
		</nav>		

		<div class="container-fluid">
            <form>

            <!-- ADMIN -->
            <div class="form-group row" id="store-section">
                <label for="name" class="col-sm-2">Admin</label>
                <div class="col-sm-10">
                    <button class="btn btn-warning" type="button" id="store-venues">Store All Wifi Venues</button>                                         
                    <button class="btn btn-warning" type="button" id="store-customers">Store Customer Configurations</button>
                    <div class="btn-group">
                        <button type="button" id="store-all" data-days="30" class="btn btn-warning">Aggregate Wifi Guests Last <span id="visitor-days2">30</span> Days</button>
                        <button type="button" class="btn btn-warning dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item store-range" href="#" data-days="7">7 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="14">14 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="30">30 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="45">45 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="60">60 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="90">90 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="120">120 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="180">180 Days</a>
                            <a class="dropdown-item store-range" href="#" data-days="365">365 Days</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group row" id="store-section">
                <label for="name" class="col-sm-2">Output</label>
                <div class="col-sm-10">
                    <pre id="output"></pre>
                </div>
            </div>
                <!-- END ADMIN -->
            </form>
        </div>
        <div class="modal fade" data-backdrop="static" id="loginModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Login</h5>
                    </div>
                    <div class="modal-body">
                        <div id="login-error" class="alert alert-danger" role="alert" style="display:none"></div>
                        <form>
                            <div class="form-group row">
                                <label for="name" class="col-sm-2">Username</label>
                                <div class="col-sm-10">
                                <input class="form-control" name="username"/>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="name" class="col-sm-2">Password</label>
                                <div class="col-sm-10">
                                <input class="form-control" type="password" name="password"/>
                                </div>
                            </div>
                        </form>						
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="login-button" class="btn btn-primary">Login</button>
                    </div>
                </div>
            </div>
        </div>        
        <script>
            // ADMIN
            // https://mnk2ecc85j.execute-api.us-east-1.amazonaws.com/dev/purpleProxy
            var proxyHost = 'mnk2ecc85j.execute-api.us-east-1.amazonaws.com';
            var purpleAggregate = 'https:/'+proxyHost+'/dev/purpleAggregateVenueVisitors';
            var purpleStore = 'https:/'+proxyHost+'/dev/purpleStore';
            var customerURL = 'https:/'+proxyHost+'/dev/customer';
			function storeCustomers() {
                var customers = [
                    {
                        id: 1335221,
                        customerName: 'LabCorp',
                        phoneAccountId: 1335221,
                        phoneApiToken: '2MGwU2rQ0dmx3ao6H89pMMhBuoUPQbxSCIyclJVCLHAQGCMw'
					},
                    {
                        id: 4286,
                        customerName: 'Spectrio',
                        purpleAccountId: 4286,
                        purplePublicKey: 'ca722481fcff8361d4fe2ac3a476aba4',
                        purplePrivateKey: 'fcc4780fc12bdf89e0bc81371e45d9b3',
                        phoneAccountId: 74241,
                        phoneApiToken: 'YcUnhXPWWwZXfj2itaF7iPhZkmCb0DIhBDPZLy8MORKr0a5H'
                    }
                    
                ];
                $('#output').text('');

                $.each(customers, function(idx, customer){
                    $.ajax({
                        contentType: "application/json; charset=utf-8",
			            dataType: "json",
                        url:customerURL + '/'+customer.id,
                        method:'PUT',
                        data: JSON.stringify(customer)
                    })
				    .done(function(responseObj) {
                        console.log(responseObj);
                        $('#output').text($('#output').text()+JSON.stringify(responseObj, null, 2)+'\n\n');

				    });
                });
                //alert('Done');
            }
            function storeVenues() {
                var p = '/api/company/v1/venues';
                $.ajax(purpleStore + '?customerId=4286&dataField=venues&path='+p)
                .done(function(responseObj) {
                    console.log(responseObj);
                    $('#output').text(JSON.stringify(responseObj, null, 2));
                });
                //alert('Done!');
            }
            function requestAggs(s, e) {
                let now = new Date();
                if(s.isBefore(now)) {
                    var q = '&from='+s.format('YYYYMMDD')+'&to='+e.format('YYYYMMDD');
                    console.log(q);
                    $.ajax(purpleAggregate + '?customerId=4286'+q)
				    .done(function(responseObj) {
                        console.log(responseObj);
                        let o = $('#output').text();
                        o += (JSON.stringify(responseObj, null, 2)+'\n');
                        $('#output').text(o);
                        s.add(2, 'days');
                        e.add(2, 'days');
                        requestAggs(s, e);
                    });
                }
                else {
                    alert('Done');
                }
                
            }

            function aggregateVisitors() {
                var range = parseInt($('#store-all').data('days'));
                var now = new Date();
                var s = moment().add(-1*range, 'days');
                var e = moment(s).add(1, 'days');
                var o = '';
                $('#output').text(null);
                requestAggs(s, e);

            }
            $(document).ready(function() {
                if (Cookies.get('loggedInX')!='true') {
                    $('#loginModal').modal('show');
                }
                $('.store-range').on('click', function() {
                    var days = $(this).data('days');
                    $('#store-all').data('days', days);
                    $('#visitor-days2').text(days);
                });
                $('#store-all').on('click', function() {
                    aggregateVisitors();
                });

                $('#store-venues').on('click', function() {
                    storeVenues();
                });
                $('#store-customers').on('click', function() {
                    storeCustomers();
                });
				$('#login-button').on('click', function() {
					var b = eval(atob('YnRvYSgkKCdbbmFtZT0icGFzc3dvcmQiXScpLnZhbCgpKSA9PSAnTVRJelUzQmxZM1J5YVc4a0pBPT0nICYmIGJ0b2EoJCgnW25hbWU9InVzZXJuYW1lIl0nKS52YWwoKSkgPT0gJ1UzQmxZM1J5YVc4PSc='));
					if (b)  {
						$('#login-error').hide();
						$('#loginModal').modal('hide');
                        Cookies.set('loggedInX', 'true', {expires:1/24});
					}
					else {
						$('#login-error').text('Invalid username or password');
						$('#login-error').show();
                        Cookies.set('loggedInX', 'false', {expires:1/24});
					}
				});
				$('#logout').on('click', function(evt) {
					Cookies.set('loggedInX', 'false', {expires:1/(24*60*60)});
					document.location.reload();
				});

            });            
            // END ADMIN               
        </script>
    </body>

</html>